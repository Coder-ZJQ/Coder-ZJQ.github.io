<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/uploads/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/uploads/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/uploads/favicon-16x16.png">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"jqz3.tech","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.10.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":true,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="一个 NSObject 对象占用多少内存？objc4 源码&amp;nbsp;NSObject.mm#L2543-L2545+ (id)alloc &amp;#123;     return _objc_rootAlloc(self);     &amp;#125;       &amp;nbsp;NSObject.mm#L1941-L1947&#x2F;&#x2F; Base class implementation of +">
<meta property="og:type" content="article">
<meta property="og:title" content="【面试题】runtime 相关">
<meta property="og:url" content="https://jqz3.tech/2018/07/18/interview-runtime/index.html">
<meta property="og:site_name" content="JQ♡TECH">
<meta property="og:description" content="一个 NSObject 对象占用多少内存？objc4 源码&amp;nbsp;NSObject.mm#L2543-L2545+ (id)alloc &amp;#123;     return _objc_rootAlloc(self);     &amp;#125;       &amp;nbsp;NSObject.mm#L1941-L1947&#x2F;&#x2F; Base class implementation of +">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://image.jqz3.tech/blog/20210821161518.png?imageView2/0/q/75|watermark/2/text/aHR0cHM6Ly9qcXozLnRlY2g=/font/bWljcm9zb2Z0IHlhaGVp/fontsize/360/fill/I0ZGRkZGRg==/dissolve/100/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://image.jqz3.tech/blog/Picture1.png?imageView2/0/q/75|watermark/2/text/aHR0cHM6Ly9qcXozLnRlY2g=/font/bWljcm9zb2Z0IHlhaGVp/fontsize/360/fill/I0ZGRkZGRg==/dissolve/100/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="https://image.jqz3.tech/blog/20210822105949.png?imageView2/0/q/75|watermark/2/text/aHR0cHM6Ly9qcXozLnRlY2g=/font/bWljcm9zb2Z0IHlhaGVp/fontsize/360/fill/I0ZGRkZGRg==/dissolve/100/gravity/SouthEast/dx/10/dy/10">
<meta property="article:published_time" content="2018-07-18T11:10:41.000Z">
<meta property="article:modified_time" content="2018-07-18T11:10:41.000Z">
<meta property="article:author" content="ZJQ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://image.jqz3.tech/blog/20210821161518.png?imageView2/0/q/75|watermark/2/text/aHR0cHM6Ly9qcXozLnRlY2g=/font/bWljcm9zb2Z0IHlhaGVp/fontsize/360/fill/I0ZGRkZGRg==/dissolve/100/gravity/SouthEast/dx/10/dy/10">


<link rel="canonical" href="https://jqz3.tech/2018/07/18/interview-runtime/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://jqz3.tech/2018/07/18/interview-runtime/","path":"2018/07/18/interview-runtime/","title":"【面试题】runtime 相关"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>【面试题】runtime 相关 | JQ♡TECH</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?31152cf49e0895a123b39ede0cf79fc9"></script>




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">JQ♡TECH</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">14</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">48</span></a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">29</span></a></li>
        <li class="menu-item menu-item-运动"><a href="https://workouts.jqz3.tech/" rel="noopener" target="_blank"><i class="fa fa-bicycle fa-fw"></i>运动</a></li>
        <li class="menu-item menu-item-commonweal"><a href="/404.html" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA-NSObject-%E5%AF%B9%E8%B1%A1%E5%8D%A0%E7%94%A8%E5%A4%9A%E5%B0%91%E5%86%85%E5%AD%98%EF%BC%9F"><span class="nav-number">1.</span> <span class="nav-text">一个 NSObject 对象占用多少内存？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#objc4-%E6%BA%90%E7%A0%81"><span class="nav-number">1.1.</span> <span class="nav-text">objc4 源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.2.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81"><span class="nav-number">1.3.</span> <span class="nav-text">验证</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81"><span class="nav-number">1.3.1.</span> <span class="nav-text">代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Debug"><span class="nav-number">1.3.2.</span> <span class="nav-text">Debug</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E5%AE%83"><span class="nav-number">1.4.</span> <span class="nav-text">其它</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%86-Objective-C-%E4%BB%A3%E7%A0%81%E8%BD%AC%E6%8D%A2%E4%B8%BA-C-C-%E4%BB%A3%E7%A0%81"><span class="nav-number">1.4.1.</span> <span class="nav-text">将 Objective-C 代码转换为 C\C++ 代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8-LLDB-%E6%8C%87%E4%BB%A4"><span class="nav-number">1.4.2.</span> <span class="nav-text">常用 LLDB 指令</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E7%9A%84-isa-%E6%8C%87%E9%92%88%E6%8C%87%E5%90%91%E5%93%AA%E9%87%8C%EF%BC%9F"><span class="nav-number">2.</span> <span class="nav-text">对象的 isa 指针指向哪里？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%81%E6%98%8E"><span class="nav-number">2.1.</span> <span class="nav-text">证明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OC-%E7%9A%84%E7%B1%BB%E4%BF%A1%E6%81%AF%E5%AD%98%E6%94%BE%E5%9C%A8%E5%93%AA%E9%87%8C%EF%BC%9F"><span class="nav-number">3.</span> <span class="nav-text">OC 的类信息存放在哪里？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#objc4-%E6%BA%90%E7%A0%81-1"><span class="nav-number">3.1.</span> <span class="nav-text">objc4 源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UML"><span class="nav-number">3.2.</span> <span class="nav-text">UML</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cache-t-%E6%96%B9%E6%B3%95%E7%BC%93%E5%AD%98"><span class="nav-number">4.</span> <span class="nav-text">cache_t 方法缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#cache-t-%E7%9B%B8%E5%85%B3%E5%BF%AB%E6%8D%B7%E6%96%B9%E6%B3%95"><span class="nav-number">4.1.</span> <span class="nav-text">cache_t 相关快捷方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bucket-t-%E7%9B%B8%E5%85%B3%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%8F%8A%E6%96%B9%E6%B3%95"><span class="nav-number">4.2.</span> <span class="nav-text">bucket_t 相关数据结构及方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%91%E6%95%A3%E5%88%97%E8%A1%A8%E4%B8%AD%E6%8F%92%E5%85%A5%E6%96%B9%E6%B3%95"><span class="nav-number">4.3.</span> <span class="nav-text">向散列表中插入方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%A3%E5%88%97%E8%A1%A8-hash-%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0"><span class="nav-number">4.4.</span> <span class="nav-text">散列表 hash 算法实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#class-rw-t-%E4%B8%8E-class-ro-t"><span class="nav-number">5.</span> <span class="nav-text">class_rw_t 与 class_ro_t</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9E%84"><span class="nav-number">5.1.</span> <span class="nav-text">结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#class-ro-t"><span class="nav-number">5.2.</span> <span class="nav-text">class_ro_t</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#class-rw-t"><span class="nav-number">5.3.</span> <span class="nav-text">class_rw_t</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#objc-msgSend-%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-number">6.</span> <span class="nav-text">objc_msgSend 执行流程</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ZJQ"
      src="/uploads/avatar.png">
  <p class="site-author-name" itemprop="name">ZJQ</p>
  <div class="site-description" itemprop="description">Stay Hungry, Stay Foolish.</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">48</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Coder-ZJQ" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Coder-ZJQ" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zjq_joker@163.com" title="E-Mail → mailto:zjq_joker@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://plus.google.com/105506194418471567135" title="Google → https:&#x2F;&#x2F;plus.google.com&#x2F;105506194418471567135" rel="noopener" target="_blank"><i class="fab fa-google fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/zjq.joker" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;zjq.joker" rel="noopener" target="_blank"><i class="fab fa-facebook fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/users/7356960/jokerq" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;7356960&#x2F;jokerq" rel="noopener" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://developer.apple.com/reference/" title="https:&#x2F;&#x2F;developer.apple.com&#x2F;reference&#x2F;" rel="noopener" target="_blank">Apple Developer Documentation</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://developer.apple.com/library/prerelease/content/navigation/" title="https:&#x2F;&#x2F;developer.apple.com&#x2F;library&#x2F;prerelease&#x2F;content&#x2F;navigation&#x2F;" rel="noopener" target="_blank">Apple Documentation Archive</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://opensource.apple.com/" title="https:&#x2F;&#x2F;opensource.apple.com&#x2F;" rel="noopener" target="_blank">Apple Open Source</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://dribbble.com/" title="https:&#x2F;&#x2F;dribbble.com&#x2F;" rel="noopener" target="_blank">dribbble</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://pttrns.com/" title="https:&#x2F;&#x2F;pttrns.com&#x2F;" rel="noopener" target="_blank">pttrns</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://www.deviantart.com/" title="http:&#x2F;&#x2F;www.deviantart.com&#x2F;" rel="noopener" target="_blank">deviant art</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/coder-zjq" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://jqz3.tech/2018/07/18/interview-runtime/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.png">
      <meta itemprop="name" content="ZJQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JQ♡TECH">
      <meta itemprop="description" content="Stay Hungry, Stay Foolish.">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="【面试题】runtime 相关 | JQ♡TECH">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          【面试题】runtime 相关<a href="https://github.com/coder-zjq/BlogSource/edit/master/source/_posts/interview-runtime.md" class="post-edit-link" title="编辑" rel="noopener" target="_blank"><i class="fa fa-pen-nib"></i></a>
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-07-18 19:10:41" itemprop="dateCreated datePublished" datetime="2018-07-18T19:10:41+08:00">2018-07-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E7%9B%B8%E5%85%B3/" itemprop="url" rel="index"><span itemprop="name">编程相关</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%9D%A2%E8%AF%95%E7%9B%B8%E5%85%B3/" itemprop="url" rel="index"><span itemprop="name">面试相关</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E7%9B%B8%E5%85%B3/Objective-C/" itemprop="url" rel="index"><span itemprop="name">Objective-C</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E7%9B%B8%E5%85%B3/Objective-C/runtime/" itemprop="url" rel="index"><span itemprop="name">runtime</span></a>
        </span>
    </span>

  
    <span id="/2018/07/18/interview-runtime/" class="post-meta-item leancloud_visitors" data-flag-title="【面试题】runtime 相关" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>27k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>25 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="一个-NSObject-对象占用多少内存？"><a href="#一个-NSObject-对象占用多少内存？" class="headerlink" title="一个 NSObject 对象占用多少内存？"></a>一个 NSObject 对象占用多少内存？</h2><h3 id="objc4-源码"><a href="#objc4-源码" class="headerlink" title="objc4 源码"></a>objc4 源码</h3><pre class="line-numbers language-objectivec" data-language="objectivec" data-start="2543" data-line="2544" data-line-offset="2542"><div class="caption"><span>&nbsp;</span><a target="_blank" rel="noopener" href="https://github.com/Coder-ZJQ/objc4-818.2/blob/main/runtime/NSObject.mm#L2543-L2545">NSObject.mm#L2543-L2545</a></div><code class="language-objectivec">+ (id)alloc &#123;
    return _objc_rootAlloc(self);
    &#125;
    </code></pre>

<pre class="line-numbers language-objectivec" data-language="objectivec" data-start="1941" data-line="1946" data-line-offset="1940"><div class="caption"><span>&nbsp;</span><a target="_blank" rel="noopener" href="https://github.com/Coder-ZJQ/objc4-818.2/blob/main/runtime/NSObject.mm#L1941-L1947">NSObject.mm#L1941-L1947</a></div><code class="language-objectivec">&#x2F;&#x2F; Base class implementation of +alloc. cls is not nil.
&#x2F;&#x2F; Calls [cls allocWithZone:nil].
id
_objc_rootAlloc(Class cls)
&#123;
    return callAlloc(cls, false&#x2F;*checkNil*&#x2F;, true&#x2F;*allocWithZone*&#x2F;);
&#125;</code></pre>

<span id="more"></span>

<pre class="line-numbers language-objectivec" data-language="objectivec" data-start="1921" data-line="1929" data-line-offset="1920"><div class="caption"><span>&nbsp;</span><a target="_blank" rel="noopener" href="https://github.com/Coder-ZJQ/objc4-818.2/blob/main/runtime/NSObject.mm#L1921-L1938">NSObject.mm#L1921-L1938</a></div><code class="language-objectivec">&#x2F;&#x2F; Call [cls alloc] or [cls allocWithZone:nil], with appropriate
&#x2F;&#x2F; shortcutting optimizations.
static ALWAYS_INLINE id
callAlloc(Class cls, bool checkNil, bool allocWithZone&#x3D;false)
&#123;
#if __OBJC2__
    if (slowpath(checkNil &amp;&amp; !cls)) return nil;
    if (fastpath(!cls-&gt;ISA()-&gt;hasCustomAWZ())) &#123;
        return _objc_rootAllocWithZone(cls, nil);
    &#125;
#endif

    &#x2F;&#x2F; No shortcuts available.
    if (allocWithZone) &#123;
        return ((id(*)(id, SEL, struct _NSZone *))objc_msgSend)(cls, @selector(allocWithZone:), nil);
    &#125;
    return ((id(*)(id, SEL))objc_msgSend)(cls, @selector(alloc));
&#125;</code></pre>


<pre class="line-numbers language-objectivec" data-language="objectivec" data-start="8016" data-line="8021" data-line-offset="8015"><div class="caption"><span>&nbsp;</span><a target="_blank" rel="noopener" href="https://github.com/Coder-ZJQ/objc4-818.2/blob/main/runtime/objc-runtime-new.mm#L8016-L8023">objc-runtime-new.mm#L8016-L8023</a></div><code class="language-objectivec">NEVER_INLINE
id
_objc_rootAllocWithZone(Class cls, malloc_zone_t *zone __unused)
&#123;
    &#x2F;&#x2F; allocWithZone under __OBJC2__ ignores the zone parameter
    return _class_createInstanceFromZone(cls, 0, nil,
                                         OBJECT_CONSTRUCT_CALL_BADALLOC);
&#125;</code></pre>


<pre class="line-numbers language-objectivec" data-language="objectivec" data-start="7955" data-line="7975,7976,7977" data-line-offset="7954"><div class="caption"><span>&nbsp;</span><a target="_blank" rel="noopener" href="https://github.com/Coder-ZJQ/objc4-818.2/blob/main/runtime/objc-runtime-new.mm#L7955-L8007">objc-runtime-new.mm#L7955-L8007</a></div><code class="language-objectivec">&#x2F;***********************************************************************
* class_createInstance
* fixme
* Locking: none
*
* Note: this function has been carefully written so that the fastpath
* takes no branch.
**********************************************************************&#x2F;
static ALWAYS_INLINE id
_class_createInstanceFromZone(Class cls, size_t extraBytes, void *zone,
                              int construct_flags &#x3D; OBJECT_CONSTRUCT_NONE,
                              bool cxxConstruct &#x3D; true,
                              size_t *outAllocatedSize &#x3D; nil)
&#123;
    ASSERT(cls-&gt;isRealized());

    &#x2F;&#x2F; Read class&#39;s info bits all at once for performance
    bool hasCxxCtor &#x3D; cxxConstruct &amp;&amp; cls-&gt;hasCxxCtor();
    bool hasCxxDtor &#x3D; cls-&gt;hasCxxDtor();
    bool fast &#x3D; cls-&gt;canAllocNonpointer();
    size_t size;

    size &#x3D; cls-&gt;instanceSize(extraBytes);
    if (outAllocatedSize) *outAllocatedSize &#x3D; size;

    id obj;
    if (zone) &#123;
        obj &#x3D; (id)malloc_zone_calloc((malloc_zone_t *)zone, 1, size);
    &#125; else &#123;
        obj &#x3D; (id)calloc(1, size);
    &#125;
    if (slowpath(!obj)) &#123;
        if (construct_flags &amp; OBJECT_CONSTRUCT_CALL_BADALLOC) &#123;
            return _objc_callBadAllocHandler(cls);
        &#125;
        return nil;
    &#125;

    if (!zone &amp;&amp; fast) &#123;
        obj-&gt;initInstanceIsa(cls, hasCxxDtor);
    &#125; else &#123;
        &#x2F;&#x2F; Use raw pointer isa on the assumption that they might be
        &#x2F;&#x2F; doing something weird with the zone or RR.
        obj-&gt;initIsa(cls);
    &#125;

    if (fastpath(!hasCxxCtor)) &#123;
        return obj;
    &#125;

    construct_flags |&#x3D; OBJECT_CONSTRUCT_FREE_ONFAILURE;
    return object_cxxConstructFromClass(obj, cls, construct_flags);
&#125;</code></pre>


<pre class="line-numbers language-objectivec" data-language="objectivec" data-start="2142" data-line="2147,2148,2149" data-line-offset="2141"><div class="caption"><span>&nbsp;</span><a target="_blank" rel="noopener" href="https://github.com/Coder-ZJQ/objc4-818.2/blob/main/runtime/objc-runtime-new.h#L2142-L2151">objc-runtime-new.h#L2142-L2151</a></div><code class="language-objectivec">inline size_t instanceSize(size_t extraBytes) const &#123;
    if (fastpath(cache.hasFastInstanceSize(extraBytes))) &#123;
        return cache.fastInstanceSize(extraBytes);
    &#125;

    size_t size &#x3D; alignedInstanceSize() + extraBytes;
    &#x2F;&#x2F; CF requires all objects be at least 16 bytes.
    if (size &lt; 16) size &#x3D; 16;
    return size;
&#125;</code></pre>


<pre class="line-numbers language-objectivec" data-language="objectivec" data-start="2137" data-line="2139" data-line-offset="2136"><div class="caption"><span>&nbsp;</span><a target="_blank" rel="noopener" href="https://github.com/Coder-ZJQ/objc4-818.2/blob/main/runtime/objc-runtime-new.h#L2137-L2140">objc-runtime-new.h#L2137-L2140</a></div><code class="language-objectivec">&#x2F;&#x2F; Class&#39;s ivar size rounded up to a pointer-size boundary.
uint32_t alignedInstanceSize() const &#123;
    return word_align(unalignedInstanceSize());
&#125;</code></pre>


<pre class="line-numbers language-objectivec" data-language="objectivec" data-start="37" data-line="48" data-line-offset="36"><div class="caption"><span>&nbsp;</span><a target="_blank" rel="noopener" href="https://github.com/Coder-ZJQ/objc4-818.2/blob/main/runtime/objc-os.h#L37-L52">objc-os.h#L37-L52</a></div><code class="language-objectivec">#ifdef __LP64__
#   define WORD_SHIFT 3UL
#   define WORD_MASK 7UL
#   define WORD_BITS 64
#else
#   define WORD_SHIFT 2UL
#   define WORD_MASK 3UL
#   define WORD_BITS 32
#endif

static inline uint32_t word_align(uint32_t x) &#123;
    return (x + WORD_MASK) &amp; ~WORD_MASK;
&#125;
static inline size_t word_align(size_t x) &#123;
    return (x + WORD_MASK) &amp; ~WORD_MASK;
&#125;</code></pre>

<p><a target="_blank" rel="noopener" href="https://unix.org/version2/whatsnew/lp64_wp.html">https://unix.org/version2/whatsnew/lp64_wp.html</a><br>LP64 (also known as 4/8/8) denotes long and pointer as 64 bit types</p>
<pre class="line-numbers language-objectivec" data-language="objectivec" data-start="2131" data-line="2134" data-line-offset="2130"><div class="caption"><span>&nbsp;</span><a target="_blank" rel="noopener" href="https://github.com/Coder-ZJQ/objc4-818.2/blob/main/runtime/objc-runtime-new.h#L2131-L2135">objc-runtime-new.h#L2131-L2135</a></div><code class="language-objectivec">&#x2F;&#x2F; May be unaligned depending on class&#39;s ivars.
uint32_t unalignedInstanceSize() const &#123;
    ASSERT(isRealized());
    return data()-&gt;ro()-&gt;instanceSize;
&#125;</code></pre>


<pre class="line-numbers language-objectivec" data-language="objectivec" data-start="2153" data-line="" data-line-offset="2152"><div class="caption"><span>&nbsp;</span><a target="_blank" rel="noopener" href="https://github.com/Coder-ZJQ/objc4-818.2/blob/main/runtime/objc-runtime-new.h#L2153-L2162">objc-runtime-new.h#L2153-L2162</a></div><code class="language-objectivec">void setInstanceSize(uint32_t newSize) &#123;
    ASSERT(isRealized());
    ASSERT(data()-&gt;flags &amp; RW_REALIZING);
    auto ro &#x3D; data()-&gt;ro();
    if (newSize !&#x3D; ro-&gt;instanceSize) &#123;
        ASSERT(data()-&gt;flags &amp; RW_COPIED_RO);
        *const_cast&lt;uint32_t *&gt;(&amp;ro-&gt;instanceSize) &#x3D; newSize;
    &#125;
    cache.setFastInstanceSize(newSize);
&#125;</code></pre>


<pre class="line-numbers language-objectivec" data-language="objectivec" data-start="7546" data-line="7570,7571,7572,7573,7574,7575,7576,7577,7578,7579,7580,7581,7582,7583,7584" data-line-offset="7545"><div class="caption"><span>&nbsp;</span><a target="_blank" rel="noopener" href="https://github.com/Coder-ZJQ/objc4-818.2/blob/main/runtime/objc-runtime-new.mm#L7546-L7623">objc-runtime-new.mm#L7546-L7623</a></div><code class="language-objectivec">static void objc_initializeClassPair_internal(Class superclass, const char *name, Class cls, Class meta)
&#123;
    runtimeLock.assertLocked();

    class_ro_t *cls_ro_w, *meta_ro_w;
    class_rw_t *cls_rw_w, *meta_rw_w;
    
    cls_rw_w   &#x3D; objc::zalloc&lt;class_rw_t&gt;();
    meta_rw_w  &#x3D; objc::zalloc&lt;class_rw_t&gt;();
    cls_ro_w   &#x3D; (class_ro_t *)calloc(sizeof(class_ro_t), 1);
    meta_ro_w  &#x3D; (class_ro_t *)calloc(sizeof(class_ro_t), 1);
    
    cls-&gt;setData(cls_rw_w);
    cls_rw_w-&gt;set_ro(cls_ro_w);
    meta-&gt;setData(meta_rw_w);
    meta_rw_w-&gt;set_ro(meta_ro_w);
    
    &#x2F;&#x2F; Set basic info
    
    cls_rw_w-&gt;flags &#x3D; RW_CONSTRUCTING | RW_COPIED_RO | RW_REALIZED | RW_REALIZING;
    meta_rw_w-&gt;flags &#x3D; RW_CONSTRUCTING | RW_COPIED_RO | RW_REALIZED | RW_REALIZING | RW_META;
    
    cls_ro_w-&gt;flags &#x3D; 0;
    meta_ro_w-&gt;flags &#x3D; RO_META;
    if (superclass) &#123;
        uint32_t flagsToCopy &#x3D; RW_FORBIDS_ASSOCIATED_OBJECTS;
        cls_rw_w-&gt;flags |&#x3D; superclass-&gt;data()-&gt;flags &amp; flagsToCopy;
        cls_ro_w-&gt;instanceStart &#x3D; superclass-&gt;unalignedInstanceSize();
        meta_ro_w-&gt;instanceStart &#x3D; superclass-&gt;ISA()-&gt;unalignedInstanceSize();
        cls-&gt;setInstanceSize(cls_ro_w-&gt;instanceStart);
        meta-&gt;setInstanceSize(meta_ro_w-&gt;instanceStart);
    &#125; else &#123;
        cls_ro_w-&gt;flags |&#x3D; RO_ROOT;
        meta_ro_w-&gt;flags |&#x3D; RO_ROOT;
        cls_ro_w-&gt;instanceStart &#x3D; 0;
        meta_ro_w-&gt;instanceStart &#x3D; (uint32_t)sizeof(objc_class);
        cls-&gt;setInstanceSize((uint32_t)sizeof(id));  &#x2F;&#x2F; just an isa
        meta-&gt;setInstanceSize(meta_ro_w-&gt;instanceStart);
    &#125;
    
    cls_ro_w-&gt;name.store(strdupIfMutable(name), std::memory_order_release);
    meta_ro_w-&gt;name.store(strdupIfMutable(name), std::memory_order_release);
    
    cls_ro_w-&gt;ivarLayout &#x3D; &amp;UnsetLayout;
    cls_ro_w-&gt;weakIvarLayout &#x3D; &amp;UnsetLayout;
    
    meta-&gt;chooseClassArrayIndex();
    cls-&gt;chooseClassArrayIndex();
    
    &#x2F;&#x2F; This absolutely needs to be done before addSubclass
    &#x2F;&#x2F; as initializeToEmpty() clobbers the FAST_CACHE bits
    cls-&gt;cache.initializeToEmpty();
    meta-&gt;cache.initializeToEmpty();

#if FAST_CACHE_META
    meta-&gt;cache.setBit(FAST_CACHE_META);
#endif
    meta-&gt;setInstancesRequireRawIsa();
    
    &#x2F;&#x2F; Connect to superclasses and metaclasses
    cls-&gt;initClassIsa(meta);
    
    if (superclass) &#123;
        meta-&gt;initClassIsa(superclass-&gt;ISA()-&gt;ISA());
        cls-&gt;setSuperclass(superclass);
        meta-&gt;setSuperclass(superclass-&gt;ISA());
        addSubclass(superclass, cls);
        addSubclass(superclass-&gt;ISA(), meta);
    &#125; else &#123;
        meta-&gt;initClassIsa(meta);
        cls-&gt;setSuperclass(Nil);
        meta-&gt;setSuperclass(cls);
        addRootClass(cls);
        addSubclass(cls, meta);
    &#125;
    
    addClassTableEntry(cls);
&#125;</code></pre>


<pre class="line-numbers language-objectivec" data-language="objectivec" data-start="53" data-line="56" data-line-offset="52"><div class="caption"><span>&nbsp;</span><a target="_blank" rel="noopener" href="https://github.com/Coder-ZJQ/objc4-818.2/blob/main/runtime/NSObject.h#L53-L58">NSObject.h#L53-L58</a></div><code class="language-objectivec">@interface NSObject &lt;NSObject&gt; &#123;
#pragma clang diagnostic push
#pragma clang diagnostic ignored &quot;-Wobjc-interface-ivars&quot;
    Class isa  OBJC_ISA_AVAILABILITY;
#pragma clang diagnostic pop
&#125;</code></pre>


<pre class="line-numbers language-objectivec" data-language="objectivec" data-start="37" data-line="38" data-line-offset="36"><div class="caption"><span>&nbsp;</span><a target="_blank" rel="noopener" href="https://github.com/Coder-ZJQ/objc4-818.2/blob/main/runtime/objc.h#L37-L38">objc.h#L37-L38</a></div><code class="language-objectivec">&#x2F;&#x2F;&#x2F; An opaque type that represents an Objective-C class.
typedef struct objc_class *Class;</code></pre>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>NSObject 对象只有一个 isa 指针成员变量</li>
<li><strong>LP64</strong> 指针类型内存中占 8 个字节</li>
<li>8 个字节 word_align 后返回 8 个字节</li>
<li>而 instanceSize 方法中限制所有对象至少 16 字节(CF requires all objects be at least 16 bytes)</li>
<li>所以一个 NSObject 对象占用 16 字节内存（但只使用了 8 字节存储 isa 指针）</li>
</ul>
<h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec">#import &lt;Foundation&#x2F;Foundation.h&gt;
#import &lt;objc&#x2F;runtime.h&gt;
#import &lt;malloc&#x2F;malloc.h&gt;

int main(int argc, const char * argv[]) &#123;
    @autoreleasepool &#123;
        NSObject *obj &#x3D; [[NSObject alloc] init];

        &#x2F;&#x2F; 获得 NSObject 类的实例对象的成员变量所占用的大小
        size_t instanceSize &#x3D; class_getInstanceSize([NSObject class]);
        &#x2F;&#x2F; 获得 obj 指针所指向内存大小
        size_t mallocSize &#x3D; malloc_size((__bridge const void *)(obj));

        NSLog(@&quot;instance size:%zu&quot;, instanceSize);  &#x2F;&#x2F; 8
        NSLog(@&quot;malloc size:%zu&quot;, mallocSize);      &#x2F;&#x2F; 16
    &#125;
    return 0;
&#125;</code></pre>

<h4 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h4><p>Debug -&gt; Debug Workflow -&gt; View Memory</p>
<img src="https://image.jqz3.tech/blog/20210821161518.png?imageView2/0/q/75|watermark/2/text/aHR0cHM6Ly9qcXozLnRlY2g=/font/bWljcm9zb2Z0IHlhaGVp/fontsize/360/fill/I0ZGRkZGRg==/dissolve/100/gravity/SouthEast/dx/10/dy/10" style="zoom: 50%;" />

<h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><h4 id="将-Objective-C-代码转换为-C-C-代码"><a href="#将-Objective-C-代码转换为-C-C-代码" class="headerlink" title="将 Objective-C 代码转换为 C\C++ 代码"></a>将 Objective-C 代码转换为 C\C++ 代码</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc 源文件 -o 输出文件</code></pre>
<p>如果需要链接其它框架，使用 -framework 参数：-framework UIKit</p>
<h4 id="常用-LLDB-指令"><a href="#常用-LLDB-指令" class="headerlink" title="常用 LLDB 指令"></a>常用 LLDB 指令</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 打印
print
p
# 打印对象
po

# 读取内存
# memory read&#x2F;数量格式字节数 内存地址
# x&#x2F;数量格式字节数 内存地址
x&#x2F;3xw 0x10011001

# 写入内存（修改内存中的值）
# memory write 内存地址 数值
memory write 0x10011001 10

# 格式
# x: 16 进制
# d: 10 进制
# f: 浮点
# s: 字符串

# 字节大小（单位）
# b: byte       1 字节
# h: half word  2 字节
# w: word       4 字节
# g: giant word 8 字节</code></pre>



<h2 id="对象的-isa-指针指向哪里？"><a href="#对象的-isa-指针指向哪里？" class="headerlink" title="对象的 isa 指针指向哪里？"></a>对象的 isa 指针指向哪里？</h2><p>OC 中对象分为：</p>
<ul>
<li>实例对象(instance object)</li>
<li>类对象(class object)</li>
<li>元类对象(meta-class object)</li>
</ul>
<p>其中：</p>
<ul>
<li>实例对象的 isa 指针指向类对象；</li>
<li>类对象的 isa 指针指向元类对象；</li>
<li>元类对象的 isa 指针指向基类的元类对象。</li>
</ul>
<img src="https://image.jqz3.tech/blog/Picture1.png?imageView2/0/q/75|watermark/2/text/aHR0cHM6Ly9qcXozLnRlY2g=/font/bWljcm9zb2Z0IHlhaGVp/fontsize/360/fill/I0ZGRkZGRg==/dissolve/100/gravity/SouthEast/dx/10/dy/10" style="zoom: 50%;" />

<h3 id="证明"><a href="#证明" class="headerlink" title="证明"></a>证明</h3><p>执行代码：</p>
<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec">#import &lt;Foundation&#x2F;Foundation.h&gt;
#import &lt;objc&#x2F;runtime.h&gt;

&#x2F;*
 objc4 源码中 isa.h L57-L113 宏定义（省略部分）
 https:&#x2F;&#x2F;github.com&#x2F;Coder-ZJQ&#x2F;objc4-818.2&#x2F;blob&#x2F;main&#x2F;runtime&#x2F;isa.h#L57-L113
 *&#x2F;
# if __arm64__
&#x2F;&#x2F; ARM64 simulators have a larger address space, so use the ARM64e
&#x2F;&#x2F; scheme even when simulators build for ARM64-not-e.
#   if __has_feature(ptrauth_calls) || TARGET_OS_SIMULATOR
#     define ISA_MASK        0x007ffffffffffff8ULL
#   else
#     define ISA_MASK        0x0000000ffffffff8ULL
#   endif
# elif __x86_64__
#   define ISA_MASK        0x00007ffffffffff8ULL
# else
#   error unknown architecture for packed isa
# endif

@interface JQObject : NSObject

@end

@implementation JQObject

@end

int main(int argc, const char * argv[]) &#123;
    @autoreleasepool &#123;

        &#x2F;&#x2F; 创建实例对象
        JQObject *obj &#x3D; [[JQObject alloc] init];
        &#x2F;&#x2F; 获取类对象
        Class class &#x3D; object_getClass(obj);
        &#x2F;&#x2F; 获取元类对象
        Class metaClass &#x3D; objc_getMetaClass(&quot;JQObject&quot;);
        &#x2F;&#x2F; 获取基类的元类对象
        Class rootMetaClass &#x3D; objc_getMetaClass(&quot;NSObject&quot;);

&#x2F;&#x2F;        &#39;obj-&gt;isa&#39; 方法已过期，使用 &#39;object_getClass(obj)&#39; 替代获取 isa 指针
&#x2F;&#x2F;        Direct access to Objective-C&#39;s isa is deprecated in favor of object_getClass()
&#x2F;&#x2F;        Replace &#39;obj-&gt;isa&#39; with &#39;object_getClass(obj)&#39;
&#x2F;&#x2F;        long isa &#x3D; (long)obj-&gt;isa;
        
        &#x2F;&#x2F; 将指针地址转换为长整型供计算
        long objIsaAddress &#x3D; (long)object_getClass(obj);
        long classAddress &#x3D; (long)class;
        long classIsaAddress &#x3D; (long)object_getClass(class);
        long metaClassAddress &#x3D; (long)metaClass;
        long metaClassIsaAddress &#x3D; (long)object_getClass(metaClass);
        long rootClassAddress &#x3D; (long)rootMetaClass;
        
        &#x2F;&#x2F; OC 运行时会对 isa 指针进行 ISA_MASK 与操作
        &#x2F;&#x2F; https:&#x2F;&#x2F;github.com&#x2F;Coder-ZJQ&#x2F;objc4-818.2&#x2F;blob&#x2F;main&#x2F;runtime&#x2F;objc-object.h#L260
        if ((objIsaAddress &amp; ISA_MASK) &#x3D;&#x3D; classAddress) &#123;
            NSLog(@&quot;实例对象的 isa 指针指向类对象&quot;);
        &#125;
        if ((classIsaAddress &amp; ISA_MASK) &#x3D;&#x3D; metaClassAddress) &#123;
            NSLog(@&quot;类对象的 isa 指针指向元类对象&quot;);
        &#125;
        if ((metaClassIsaAddress &amp; ISA_MASK) &#x3D;&#x3D; rootClassAddress) &#123;
            NSLog(@&quot;元类对象的 isa 指针指向基类的元类对象&quot;);
        &#125;
    &#125;
    return 0;
&#125;</code></pre>

<p>输出：</p>
<img src="https://image.jqz3.tech/blog/20210822105949.png?imageView2/0/q/75|watermark/2/text/aHR0cHM6Ly9qcXozLnRlY2g=/font/bWljcm9zb2Z0IHlhaGVp/fontsize/360/fill/I0ZGRkZGRg==/dissolve/100/gravity/SouthEast/dx/10/dy/10" style="zoom:50%;" />

<p>示例项目地址：<br><a target="_blank" rel="noopener" href="https://github.com/Coder-ZJQ/demos/tree/master/interview/oc-isa-to">https://github.com/Coder-ZJQ/demos/tree/master/interview/oc-isa-to</a></p>
<h2 id="OC-的类信息存放在哪里？"><a href="#OC-的类信息存放在哪里？" class="headerlink" title="OC 的类信息存放在哪里？"></a>OC 的类信息存放在哪里？</h2><h3 id="objc4-源码-1"><a href="#objc4-源码-1" class="headerlink" title="objc4 源码"></a>objc4 源码</h3><pre class="line-numbers language-objectivec" data-language="objectivec" data-start="53" data-line="56" data-line-offset="52"><div class="caption"><span>&nbsp;</span><a target="_blank" rel="noopener" href="https://github.com/Coder-ZJQ/objc4-818.2/blob/main/runtime/NSObject.h#L53-L58">NSObject.h#L53-L58</a></div><code class="language-objectivec">@interface NSObject &lt;NSObject&gt; &#123;
#pragma clang diagnostic push
#pragma clang diagnostic ignored &quot;-Wobjc-interface-ivars&quot;
    Class isa  OBJC_ISA_AVAILABILITY;
#pragma clang diagnostic pop
&#125;</code></pre>



<pre class="line-numbers language-objectivec" data-language="objectivec" data-start="37" data-line="38" data-line-offset="36"><div class="caption"><span>&nbsp;</span><a target="_blank" rel="noopener" href="https://github.com/Coder-ZJQ/objc4-818.2/blob/main/runtime/objc.h#L37-L38">objc.h#L37-L38</a></div><code class="language-objectivec">&#x2F;&#x2F;&#x2F; An opaque type that represents an Objective-C class.
typedef struct objc_class *Class;</code></pre>


<pre class="line-numbers language-objectivec" data-language="objectivec" data-start="1688" data-line="1694,1695,1696" data-line-offset="1687"><div class="caption"><span>&nbsp;</span><a target="_blank" rel="noopener" href="https://github.com/Coder-ZJQ/objc4-818.2/blob/main/runtime/objc-runtime-new.h#L1688-L1696">objc-runtime-new.h#L1688-L1696</a></div><code class="language-objectivec">struct objc_class : objc_object &#123;
  objc_class(const objc_class&amp;) &#x3D; delete;
  objc_class(objc_class&amp;&amp;) &#x3D; delete;
  void operator&#x3D;(const objc_class&amp;) &#x3D; delete;
  void operator&#x3D;(objc_class&amp;&amp;) &#x3D; delete;
    &#x2F;&#x2F; Class ISA;
    Class superclass;
    cache_t cache;             &#x2F;&#x2F; formerly cache pointer and vtable
    class_data_bits_t bits;    &#x2F;&#x2F; class_rw_t * plus custom rr&#x2F;alloc flags</code></pre>

<pre class="line-numbers language-objectivec" data-language="objectivec" data-start="40" data-line="42" data-line-offset="39"><div class="caption"><span>&nbsp;</span><a target="_blank" rel="noopener" href="https://github.com/Coder-ZJQ/objc4-818.2/blob/main/runtime/objc.h#L40-L43">objc.h#L40-L43</a></div><code class="language-objectivec">&#x2F;&#x2F;&#x2F; Represents an instance of a class.
struct objc_object &#123;
    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;
&#125;;</code></pre>


<pre class="language-objectivec" data-language="objectivec" data-line="1609,1610,1611" data-line-offset="1602"><div class="caption"><span>&nbsp;</span><a target="_blank" rel="noopener" href="https://github.com/Coder-ZJQ/objc4-818.2/blob/main/runtime/objc-runtime-new.h#L1609-L1611">objc-runtime-new.h#L1609-L1611</a></div><code class="language-objectivec">struct class_data_bits_t &#123;
&#x2F;&#x2F; ......
public:

    class_rw_t* data() const &#123;
        return (class_rw_t *)(bits &amp; FAST_DATA_MASK);
    &#125;
&#x2F;&#x2F; ......
&#125;</code></pre>


<pre class="language-objectivec" data-language="objectivec" data-line="1531,1532,1533,1534,1535,1536,1537,1548,1549,1550,1551,1552,1553,1554,1555,1557,1558,1559,1560,1561,1562,1563,1564,1566,1567,1568,1569,1570,1571,1572,1573" data-line-offset="1524"><div class="caption"><span>&nbsp;</span><a target="_blank" rel="noopener" href="https://github.com/Coder-ZJQ/objc4-818.2/blob/main/runtime/objc-runtime-new.h#L1458-L1574">objc-runtime-new.h#L1458-L1574</a></div><code class="language-objectivec">struct class_rw_t &#123;

    &#x2F;&#x2F; ......
    
    const class_ro_t *ro() const &#123;
        auto v &#x3D; get_ro_or_rwe();
        if (slowpath(v.is&lt;class_rw_ext_t *&gt;())) &#123;
            return v.get&lt;class_rw_ext_t *&gt;(&amp;ro_or_rw_ext)-&gt;ro;
        &#125;
        return v.get&lt;const class_ro_t *&gt;(&amp;ro_or_rw_ext);
    &#125;
    
    void set_ro(const class_ro_t *ro) &#123;
        auto v &#x3D; get_ro_or_rwe();
        if (v.is&lt;class_rw_ext_t *&gt;()) &#123;
            v.get&lt;class_rw_ext_t *&gt;(&amp;ro_or_rw_ext)-&gt;ro &#x3D; ro;
        &#125; else &#123;
            set_ro_or_rwe(ro);
        &#125;
    &#125;
    
    const method_array_t methods() const &#123;
        auto v &#x3D; get_ro_or_rwe();
        if (v.is&lt;class_rw_ext_t *&gt;()) &#123;
            return v.get&lt;class_rw_ext_t *&gt;(&amp;ro_or_rw_ext)-&gt;methods;
        &#125; else &#123;
            return method_array_t&#123;v.get&lt;const class_ro_t *&gt;(&amp;ro_or_rw_ext)-&gt;baseMethods()&#125;;
        &#125;
    &#125;
    
    const property_array_t properties() const &#123;
        auto v &#x3D; get_ro_or_rwe();
        if (v.is&lt;class_rw_ext_t *&gt;()) &#123;
            return v.get&lt;class_rw_ext_t *&gt;(&amp;ro_or_rw_ext)-&gt;properties;
        &#125; else &#123;
            return property_array_t&#123;v.get&lt;const class_ro_t *&gt;(&amp;ro_or_rw_ext)-&gt;baseProperties&#125;;
        &#125;
    &#125;
    
    const protocol_array_t protocols() const &#123;
        auto v &#x3D; get_ro_or_rwe();
        if (v.is&lt;class_rw_ext_t *&gt;()) &#123;
            return v.get&lt;class_rw_ext_t *&gt;(&amp;ro_or_rw_ext)-&gt;protocols;
        &#125; else &#123;
            return protocol_array_t&#123;v.get&lt;const class_ro_t *&gt;(&amp;ro_or_rw_ext)-&gt;baseProtocols&#125;;
        &#125;
    &#125;
&#125;;</code></pre>


<pre class="language-objectivec" data-language="objectivec" data-line="1039,1040,1055" data-line-offset="1034"><div class="caption"><span>&nbsp;</span><a target="_blank" rel="noopener" href="https://github.com/Coder-ZJQ/objc4-818.2/blob/main/runtime/objc-runtime-new.h#L1037-L1171">objc-runtime-new.h#L1037-L1171</a></div><code class="language-objectivec">struct class_ro_t &#123;
    uint32_t flags;
    uint32_t instanceStart;
    uint32_t instanceSize;
#ifdef __LP64__
    uint32_t reserved;
#endif

    union &#123;
        const uint8_t * ivarLayout;
        Class nonMetaclass;
    &#125;;
    
    explicit_atomic&lt;const char *&gt; name;
    &#x2F;&#x2F; With ptrauth, this is signed if it points to a small list, but
    &#x2F;&#x2F; may be unsigned if it points to a big list.
    void *baseMethodList;
    protocol_list_t * baseProtocols;
    const ivar_list_t * ivars;
    
    &#x2F;&#x2F; ......

&#125;</code></pre>

<h3 id="UML"><a href="#UML" class="headerlink" title="UML"></a>UML</h3><pre class="mermaid">
classDiagram

class Class
class objc_class {
  Class superclass
  cache_t cache
  class_data_bits_t bits
}
class objc_object {
  Class isa
}
class NSObject {
  Class isa
}
class class_data_bits_t {
  class_rw_t* data
}
class class_rw_t {
  class_ro_t *ro
  method_array_t methods
  property_array_t properties
  protocol_array_t protocols
}
class class_ro_t {
  uint32_t instanceStart
  uint32_t instanceSize
  ivar_list_t * ivars
}

NSObject..&gt;Class
objc_object..&gt;Class
objc_class..&gt;Class
Class--&gt;objc_class : typedef
objc_class--|&gt;objc_object
objc_class..&gt;class_data_bits_t
class_data_bits_t..&gt;class_rw_t
class_rw_t..&gt;class_ro_t

link NSObject &quot;https:&#x2F;&#x2F;github.com&#x2F;Coder-ZJQ&#x2F;objc4-818.2&#x2F;blob&#x2F;main&#x2F;runtime&#x2F;NSObject.h#L53-L58&quot;
link Class &quot;https:&#x2F;&#x2F;github.com&#x2F;Coder-ZJQ&#x2F;objc4-818.2&#x2F;blob&#x2F;main&#x2F;runtime&#x2F;objc.h#L37-L38&quot;
link objc_class &quot;https:&#x2F;&#x2F;github.com&#x2F;Coder-ZJQ&#x2F;objc4-818.2&#x2F;blob&#x2F;main&#x2F;runtime&#x2F;objc-runtime-new.h#L1688-L1696&quot;
link objc_object &quot;https:&#x2F;&#x2F;github.com&#x2F;Coder-ZJQ&#x2F;objc4-818.2&#x2F;blob&#x2F;main&#x2F;runtime&#x2F;objc.h#L40-L43&quot;
link class_data_bits_t &quot;https:&#x2F;&#x2F;github.com&#x2F;Coder-ZJQ&#x2F;objc4-818.2&#x2F;blob&#x2F;main&#x2F;runtime&#x2F;objc-runtime-new.h#L1609-L1611&quot;
link class_rw_t &quot;https:&#x2F;&#x2F;github.com&#x2F;Coder-ZJQ&#x2F;objc4-818.2&#x2F;blob&#x2F;main&#x2F;runtime&#x2F;objc-runtime-new.h#L1458-L1574&quot;
link class_ro_t &quot;https:&#x2F;&#x2F;github.com&#x2F;Coder-ZJQ&#x2F;objc4-818.2&#x2F;blob&#x2F;main&#x2F;runtime&#x2F;objc-runtime-new.h#L1037-L1171&quot;


</pre>



<h2 id="cache-t-方法缓存"><a href="#cache-t-方法缓存" class="headerlink" title="cache_t 方法缓存"></a>cache_t 方法缓存</h2><h3 id="cache-t-相关快捷方法"><a href="#cache-t-相关快捷方法" class="headerlink" title="cache_t 相关快捷方法"></a>cache_t 相关快捷方法</h3><pre class="language-cpp" data-language="cpp" data-line="" data-line-offset="0"><div class="caption"><span>&nbsp;</span><a target="_blank" rel="noopener" href="https://github.com/Coder-ZJQ/objc4-818.2/blob/main/runtime/objc-runtime-new.h#L338-L550">objc-runtime-new.h#L338-L550</a></div><code class="language-cpp">struct cache_t &#123;
    struct bucket_t *buckets() const; &#x2F;&#x2F; 散列表
    unsigned capacity() const;        &#x2F;&#x2F; 散列表的长度
    mask_t mask() const;              &#x2F;&#x2F; 散列表的长度 - 1
    mask_t occupied() const;          &#x2F;&#x2F; 已缓存的方法数量
&#125;</code></pre>

<h3 id="bucket-t-相关数据结构及方法"><a href="#bucket-t-相关数据结构及方法" class="headerlink" title="bucket_t 相关数据结构及方法"></a>bucket_t 相关数据结构及方法</h3><pre class="language-cpp" data-language="cpp" data-line="" data-line-offset="0"><div class="caption"><span>&nbsp;</span><a target="_blank" rel="noopener" href="https://github.com/Coder-ZJQ/objc4-818.2/blob/main/runtime/objc-runtime-new.h#L212-L290">objc-runtime-new.h#L212-L290</a></div><code class="language-cpp">struct bucket_t &#123;
private:
    explicit_atomic&lt;uintptr_t&gt; _imp;
    explicit_atomic&lt;SEL&gt; _sel;

public:
    inline SEL sel() const &#123; return _sel.load(memory_order_relaxed); &#125;
#if CACHE_IMP_ENCODING &#x3D;&#x3D; CACHE_IMP_ENCODING_ISA_XOR
#define MAYBE_UNUSED_ISA
#else
#define MAYBE_UNUSED_ISA __attribute__((unused))
#endif
    inline IMP rawImp(MAYBE_UNUSED_ISA objc_class *cls) const &#123;
        uintptr_t imp &#x3D; _imp.load(memory_order_relaxed);
        if (!imp) return nil;
#if CACHE_IMP_ENCODING &#x3D;&#x3D; CACHE_IMP_ENCODING_PTRAUTH
#elif CACHE_IMP_ENCODING &#x3D;&#x3D; CACHE_IMP_ENCODING_ISA_XOR
        imp ^&#x3D; (uintptr_t)cls;
#elif CACHE_IMP_ENCODING &#x3D;&#x3D; CACHE_IMP_ENCODING_NONE
#else
#error Unknown method cache IMP encoding.
#endif
        return (IMP)imp;
    &#125;
    
    inline IMP imp(UNUSED_WITHOUT_PTRAUTH bucket_t *base, Class cls) const &#123;
        uintptr_t imp &#x3D; _imp.load(memory_order_relaxed);
        if (!imp) return nil;
#if CACHE_IMP_ENCODING &#x3D;&#x3D; CACHE_IMP_ENCODING_PTRAUTH
        SEL sel &#x3D; _sel.load(memory_order_relaxed);
        return (IMP)
            ptrauth_auth_and_resign((const void *)imp,
                                    ptrauth_key_process_dependent_code,
                                    modifierForSEL(base, sel, cls),
                                    ptrauth_key_function_pointer, 0);
#elif CACHE_IMP_ENCODING &#x3D;&#x3D; CACHE_IMP_ENCODING_ISA_XOR
        return (IMP)(imp ^ (uintptr_t)cls);
#elif CACHE_IMP_ENCODING &#x3D;&#x3D; CACHE_IMP_ENCODING_NONE
        return (IMP)imp;
#else
#error Unknown method cache IMP encoding.
#endif
    &#125;

&#125;</code></pre>

<h3 id="向散列表中插入方法"><a href="#向散列表中插入方法" class="headerlink" title="向散列表中插入方法"></a>向散列表中插入方法</h3><pre class="language-cpp" data-language="cpp" data-line="" data-line-offset="0"><div class="caption"><span>&nbsp;</span><a target="_blank" rel="noopener" href="https://github.com/Coder-ZJQ/objc4-818.2/blob/main/runtime/objc-cache.mm#L826-L895">objc-cache.mm#L826-L895</a></div><code class="language-cpp">void cache_t::insert(SEL sel, IMP imp, id receiver)
&#123;
    runtimeLock.assertLocked();

    &#x2F;&#x2F; Never cache before +initialize is done
    if (slowpath(!cls()-&gt;isInitialized())) &#123;
        return;
    &#125;
    
    if (isConstantOptimizedCache()) &#123;
        _objc_fatal(&quot;cache_t::insert() called with a preoptimized cache for %s&quot;,
                    cls()-&gt;nameForLogging());
    &#125;

#if DEBUG_TASK_THREADS
    return _collecting_in_critical();
#else
#if CONFIG_USE_CACHE_LOCK
    mutex_locker_t lock(cacheUpdateLock);
#endif

    ASSERT(sel !&#x3D; 0 &amp;&amp; cls()-&gt;isInitialized());
    
    &#x2F;&#x2F; Use the cache as-is if until we exceed our expected fill ratio.
    mask_t newOccupied &#x3D; occupied() + 1;
    unsigned oldCapacity &#x3D; capacity(), capacity &#x3D; oldCapacity;
    if (slowpath(isConstantEmptyCache())) &#123;
        &#x2F;&#x2F; Cache is read-only. Replace it.
        if (!capacity) capacity &#x3D; INIT_CACHE_SIZE;
        reallocate(oldCapacity, capacity, &#x2F;* freeOld *&#x2F;false);
    &#125;
    else if (fastpath(newOccupied + CACHE_END_MARKER &lt;&#x3D; cache_fill_ratio(capacity))) &#123;
        &#x2F;&#x2F; Cache is less than 3&#x2F;4 or 7&#x2F;8 full. Use it as-is.
    &#125;
#if CACHE_ALLOW_FULL_UTILIZATION
    else if (capacity &lt;&#x3D; FULL_UTILIZATION_CACHE_SIZE &amp;&amp; newOccupied + CACHE_END_MARKER &lt;&#x3D; capacity) &#123;
        &#x2F;&#x2F; Allow 100% cache utilization for small buckets. Use it as-is.
    &#125;
#endif
    else &#123;
        capacity &#x3D; capacity ? capacity * 2 : INIT_CACHE_SIZE;
        if (capacity &gt; MAX_CACHE_SIZE) &#123;
            capacity &#x3D; MAX_CACHE_SIZE;
        &#125;
        reallocate(oldCapacity, capacity, true);
    &#125;
    
    bucket_t *b &#x3D; buckets();
    mask_t m &#x3D; capacity - 1;
    mask_t begin &#x3D; cache_hash(sel, m);
    mask_t i &#x3D; begin;
    
    &#x2F;&#x2F; Scan for the first unused slot and insert there.
    &#x2F;&#x2F; There is guaranteed to be an empty slot.
    do &#123;
        if (fastpath(b[i].sel() &#x3D;&#x3D; 0)) &#123;
            incrementOccupied();
            b[i].set&lt;Atomic, Encoded&gt;(b, sel, imp, cls());
            return;
        &#125;
        if (b[i].sel() &#x3D;&#x3D; sel) &#123;
            &#x2F;&#x2F; The entry was added to the cache by some other thread
            &#x2F;&#x2F; before we grabbed the cacheUpdateLock.
            return;
        &#125;
    &#125; while (fastpath((i &#x3D; cache_next(i, m)) !&#x3D; begin));
    
    bad_cache(receiver, (SEL)sel);
#endif &#x2F;&#x2F; !DEBUG_TASK_THREADS
&#125;</code></pre>

<h3 id="散列表-hash-算法实现"><a href="#散列表-hash-算法实现" class="headerlink" title="散列表 hash 算法实现"></a>散列表 hash 算法实现</h3><pre class="language-cpp" data-language="cpp" data-line="" data-line-offset="0"><div class="caption"><span>&nbsp;</span><a target="_blank" rel="noopener" href="https://github.com/Coder-ZJQ/objc4-818.2/blob/main/runtime/objc-cache.mm#L304-L314">objc-cache.mm#L304-L314</a></div><code class="language-cpp">&#x2F;&#x2F; Class points to cache. SEL is key. Cache buckets store SEL+IMP.
&#x2F;&#x2F; Caches are never built in the dyld shared cache.

static inline mask_t cache_hash(SEL sel, mask_t mask) 
&#123;
    uintptr_t value &#x3D; (uintptr_t)sel;
#if CONFIG_USE_PREOPT_CACHES
    value ^&#x3D; value &gt;&gt; 7;
#endif
    return (mask_t)(value &amp; mask);
&#125;</code></pre>

<h2 id="class-rw-t-与-class-ro-t"><a href="#class-rw-t-与-class-ro-t" class="headerlink" title="class_rw_t 与 class_ro_t"></a>class_rw_t 与 class_ro_t</h2><h3 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h3><p>通过阅读 obj4 源码可以得出 <code>class_rw_t</code> 与 <code>class_ro_t</code> 结构（部分省略），如下：<br>(objc4 源码版本：<a target="_blank" rel="noopener" href="https://opensource.apple.com/source/objc4/objc4-818.2/">objc4-818.2</a>)</p>
<pre class="mermaid">
flowchart LR

subgraph class_rw_t
    A[&quot;class_ro_t *ro()&quot;]
    B[&quot;method_array_t methods()&quot;]
    C[&quot;property_array_t properties()&quot;]
    D[&quot;protocol_array_t protocols()&quot;]
    DD[&quot;......&quot;]
end

subgraph class_ro_t
    E[&quot;uint32_t instanceSize;&quot;]
    F[&quot;method_list_t *baseMethods()&quot;]
    G[&quot;property_list_t *baseProperties;&quot;]
    H[&quot;protocol_list_t *baseProtocols;&quot;]
    I[&quot;const ivar_list_t * ivars;&quot;]
    II[&quot;......&quot;]
end

J[&quot;method_array_t&quot;]
K[&quot;property_array_t&quot;]
L[&quot;protocol_array_t&quot;]
M[method_list_t]
N[property_list_t]
O[protocol_list_t]
P[ivar_list_t]

subgraph method_t
    direction LR
    U[&quot;SEL name;&quot;]
    V[&quot;const char *types;&quot;]
    W[&quot;IMP imp;&quot;]
    WW[&quot;......&quot;]
end

subgraph property_t
    direction LR
    Q[&quot;const char *name;&quot;]
    R[&quot;const char *attributes;&quot;]
end

subgraph protocol_t
    direction LR
    X[&quot;struct protocol_list_t *protocols;&quot;]
    Y[&quot;method_list_t *instanceMethods;&quot;]
    Z[&quot;method_list_t *classMethods;&quot;]
    ZZ[&quot;property_list_t *instanceProperties;&quot;]
    ZZZ[&quot;......&quot;]
end

subgraph ivar_t
    direction LR
    S[&quot;const char *name;&quot;]
    T[&quot;const char *type;&quot;]
    TT[&quot;......&quot;]
end

A--&gt;class_ro_t
B--&gt;J
C--&gt;K
D--&gt;L
F--&gt;M
G--&gt;N
H--&gt;O
I--&gt;P
J--&gt;M
K--&gt;N
L--&gt;O
M--&gt;method_t
N--&gt;property_t
O--&gt;protocol_t
P--&gt;ivar_t

</pre>

<h3 id="class-ro-t"><a href="#class-ro-t" class="headerlink" title="class_ro_t"></a>class_ro_t</h3><ul>
<li>class_ro_t 里面的 baseMethodList、baseProtocols、ivars、baseProperties 是一维数组，是只读的，包含了类的初始内容；</li>
<li>class_ro_t 编译时即确定；</li>
</ul>
<h3 id="class-rw-t"><a href="#class-rw-t" class="headerlink" title="class_rw_t"></a>class_rw_t</h3><ul>
<li>class_rw_t 里面的 methods、properties、protocols 是二维数组，是可读可写的，包含了类的初始内容、分类的内容；</li>
<li>class_rw_t 运行时才确定，且会先拷贝 class_ro_t 中的内容；</li>
<li>class_rw_t 中已包含 class_ro_t 的相关内容，所以访问类的方法属性协议等主要通过 class_rw_t，不通过 class_ro_t。</li>
</ul>
<p>拷贝 class_ro_t 中内容至 class_rw_t 源码：</p>
<pre class="line-numbers language-objectivec" data-language="objectivec" data-start="1468" data-line="1489,1490,1491,1492,1493,1494,1495,1496,1497,1498,1499,1500,1501,1502,1503,1504" data-line-offset="1467"><div class="caption"><span>&nbsp;</span><a target="_blank" rel="noopener" href="https://github.com/Coder-ZJQ/objc4-818.2/blob/main/runtime/objc-runtime-new.mm#L1468-L1539">objc-runtime-new.mm#L1468-L1539</a></div><code class="language-objectivec">&#x2F;***********************************************************************
* methodizeClass
* Fixes up cls&#39;s method list, protocol list, and property list.
* Attaches any outstanding categories.
* Locking: runtimeLock must be held by the caller
  **********************************************************************&#x2F;
  static void methodizeClass(Class cls, Class previously)
  &#123;
    runtimeLock.assertLocked();

    bool isMeta &#x3D; cls-&gt;isMetaClass();
    auto rw &#x3D; cls-&gt;data();
    auto ro &#x3D; rw-&gt;ro();
    auto rwe &#x3D; rw-&gt;ext();

    &#x2F;&#x2F; Methodizing for the first time
    if (PrintConnecting) &#123;
        _objc_inform(&quot;CLASS: methodizing class &#39;%s&#39; %s&quot;, 
                     cls-&gt;nameForLogging(), isMeta ? &quot;(meta)&quot; : &quot;&quot;);
    &#125;

    &#x2F;&#x2F; Install methods and properties that the class implements itself.
    method_list_t *list &#x3D; ro-&gt;baseMethods();
    if (list) &#123;
        prepareMethodLists(cls, &amp;list, 1, YES, isBundleClass(cls), nullptr);
        if (rwe) rwe-&gt;methods.attachLists(&amp;list, 1);
    &#125;

    property_list_t *proplist &#x3D; ro-&gt;baseProperties;
    if (rwe &amp;&amp; proplist) &#123;
        rwe-&gt;properties.attachLists(&amp;proplist, 1);
    &#125;

    protocol_list_t *protolist &#x3D; ro-&gt;baseProtocols;
    if (rwe &amp;&amp; protolist) &#123;
        rwe-&gt;protocols.attachLists(&amp;protolist, 1);
    &#125;

    &#x2F;&#x2F; Root classes get bonus method implementations if they don&#39;t have 
    &#x2F;&#x2F; them already. These apply before category replacements.
    if (cls-&gt;isRootMetaclass()) &#123;
        &#x2F;&#x2F; root metaclass
        addMethod(cls, @selector(initialize), (IMP)&amp;objc_noop_imp, &quot;&quot;, NO);
    &#125;

    &#x2F;&#x2F; Attach categories.
    if (previously) &#123;
        if (isMeta) &#123;
            objc::unattachedCategories.attachToClass(cls, previously,
                                                     ATTACH_METACLASS);
        &#125; else &#123;
            &#x2F;&#x2F; When a class relocates, categories with class methods
            &#x2F;&#x2F; may be registered on the class itself rather than on
            &#x2F;&#x2F; the metaclass. Tell attachToClass to look for those.
            objc::unattachedCategories.attachToClass(cls, previously,
                                                     ATTACH_CLASS_AND_METACLASS);
        &#125;
    &#125;
    objc::unattachedCategories.attachToClass(cls, cls,
                                             isMeta ? ATTACH_METACLASS : ATTACH_CLASS);

#if DEBUG
    &#x2F;&#x2F; Debug: sanity-check all SELs; log method list contents
    for (const auto&amp; meth : rw-&gt;methods()) &#123;
        if (PrintConnecting) &#123;
            _objc_inform(&quot;METHOD %c[%s %s]&quot;, isMeta ? &#39;+&#39; : &#39;-&#39;, 
                         cls-&gt;nameForLogging(), sel_getName(meth.name()));
        &#125;
        ASSERT(sel_registerName(sel_getName(meth.name())) &#x3D;&#x3D; meth.name());
    &#125;
#endif
&#125;</code></pre>



<h2 id="objc-msgSend-执行流程"><a href="#objc-msgSend-执行流程" class="headerlink" title="objc_msgSend 执行流程"></a>objc_msgSend 执行流程</h2><!-- 汇编源码

ENTRY _objc_msgSend

b.le LNilOrTagged

b    LGetIsaDone

CacheLookup NORMAL, _objc_msgSend, __objc_msgSend_uncached

.macro CacheLookup Mode, Function, MissLabelDynamic, MissLabelConstant

CacheHit

__objc_msgSend_uncached

MethodTableLookup

_lookUpImpOrForward

_objc_msgForward_impcache

getMethodNoSuper_nolock

search_method_list_inline

log_and_fill_cache

__objc_msgForward

_objc_forward_handler

objc_defaultForwardHandler

_objc_msgForward

objc_setForwardHandler

 -->

<pre class="mermaid">
flowchart TB
 A(objc_msgSend)
 B{消息接收者是否为nil}
 C([退出])
 D{在 cache 中查找}
 E{在 class_rw_t 中查找}
 F{在 cache 中查找}
 G{在 class_rw_t 中查找}
 H{superclass &#x3D;&#x3D; nil}
 I{是否动态方法解析}
 J([调用方法结束查找])
 K([调用方法结束查找并将方法缓存至 cache])
 L[+resolveInstanceMethod:]
 M[+resolveClassMethod:]
N{类对象还是实例对象}
O{+&#x2F;- forwardingTargetForSelector:}
P{+&#x2F;- methodSignatureForSelector:}
Q[调用 +&#x2F;- forwardInvocation: 方法]
R[调用 doesNotRecognizeSelector: 方法抛出异常]
S[&quot;调用 objc_msgSend(返回值, selector)&quot;]

 subgraph 消息发送
   subgraph &quot;消息接受者的类对象(isa)&quot;
		D
		E
   end
   subgraph &quot;消息接受者的父类对象(superclass)&quot;
		F
		G
   end
   B
   C
   H
   J
   K
 end
 subgraph 动态方法解析
   I
   L
   M
   N
 end
 subgraph 消息转发
   O
   P
   Q
   R
   S
 end
 A--&gt;B
 B--&gt;|是|C
 B--&gt;|否|D
 D--&gt;|未找到|E
 E--&gt;|未找到|H
 H--&gt;|否|F
 H--&gt;|是|I
 F--&gt;|未找到|G
 G--&gt;|未找到|H
 D--&gt;|找到了|J
 E--&gt;|找到了|K
 F--&gt;|找到了|J
 G--&gt;|找到了|K
 I--&gt;|否|N
 I--&gt;|是|O
 N--&gt;|实例对象|L
 N--&gt;|类对象|M
 L--&gt;|返回YES|D
 M--&gt;|返回YES|D
 O--&gt;|返回值不为nil|S
 O--&gt;|返回值为nil|P
 P--&gt;|返回值不为nil|Q
 P--&gt;|返回值为nil|R

</pre>



<pre class="line-numbers language-objectivec" data-language="objectivec"><code class="language-objectivec">#import &lt;Foundation&#x2F;Foundation.h&gt;
#import &lt;objc&#x2F;runtime.h&gt;

@interface JQForwardObject : NSObject

- (void)test;
+ (void)test;

@end

@implementation JQForwardObject

- (void)test &#123;
    NSLog(@&quot;\nfunc: %s\nreceiver: %@\nsel: %@&quot;, __func__, self, NSStringFromSelector(_cmd));
&#125;

+ (void)test &#123;
    NSLog(@&quot;\nfunc: %s\nreceiver: %@\nsel: %@&quot;, __func__, self, NSStringFromSelector(_cmd));
&#125;

@end

@interface JQObject : NSObject

- (void)test;
+ (void)test;

@end

@implementation JQObject
&#x2F;* 1. 动态消息解析
+ (BOOL)resolveClassMethod:(SEL)sel &#123;
    if (sel &#x3D;&#x3D; @selector(test)) &#123;
        Method met &#x3D; class_getInstanceMethod(self, @selector(resolveMethod));
        class_addMethod(object_getClass(self), sel, method_getImplementation(met), method_getTypeEncoding(met));
        return YES;
    &#125;
    return [super resolveClassMethod:sel];
&#125;

+ (BOOL)resolveInstanceMethod:(SEL)sel &#123;
    if (sel &#x3D;&#x3D; @selector(test)) &#123;
        class_addMethod(self, sel, (IMP)resolveMethod, &quot;v@:&quot;);
        return YES;
    &#125;
    return [super resolveInstanceMethod:sel];
&#125;

- (void)resolveMethod &#123;
    NSLog(@&quot;\nfunc: %s\nreceiver: %@\nsel: %@&quot;, __func__, self, NSStringFromSelector(_cmd));
&#125;

void resolveMethod(id self, SEL _cmd) &#123;
    NSLog(@&quot;\nfunc: %s\nreceiver: %@\nsel: %@&quot;, __func__, self, NSStringFromSelector(_cmd));
&#125;
*&#x2F;

&#x2F;*
- (id)forwardingTargetForSelector:(SEL)aSelector &#123;
    if (aSelector &#x3D;&#x3D; @selector(test)) &#123;
        return [[JQForwardObject alloc] init];
    &#125;
    return [super forwardingTargetForSelector:aSelector];
&#125;

+ (id)forwardingTargetForSelector:(SEL)aSelector &#123;
    if (aSelector &#x3D;&#x3D; @selector(test)) &#123;
        return [JQForwardObject class];
    &#125;
    return [super forwardingTargetForSelector:aSelector];
&#125;
*&#x2F;

- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector &#123;
    if (aSelector &#x3D;&#x3D; @selector(test)) &#123;
        return [NSMethodSignature signatureWithObjCTypes:&quot;v@:&quot;];
    &#125;
    return [super methodSignatureForSelector:aSelector];
&#125;

- (void)forwardInvocation:(NSInvocation *)anInvocation &#123;
&#x2F;&#x2F;    anInvocation getReturnValue:&lt;#(nonnull void *)#&gt;
&#x2F;&#x2F;    anInvocation getArgument:&lt;#(nonnull void *)#&gt; atIndex:&lt;#(NSInteger)#&gt;
&#x2F;&#x2F;    anInvocation invoke
&#x2F;&#x2F;    [anInvocation invokeWithTarget:&lt;#(nonnull id)#&gt;];
    NSLog(@&quot;%@&quot;, anInvocation);
&#125;

+ (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector &#123;
    if (aSelector &#x3D;&#x3D; @selector(test)) &#123;
        return [NSMethodSignature signatureWithObjCTypes:&quot;v@:&quot;];
    &#125;
    return [super methodSignatureForSelector:aSelector];
&#125;

+ (void)forwardInvocation:(NSInvocation *)anInvocation &#123;
    NSLog(@&quot;%@&quot;, anInvocation);
&#125;

@end



int main(int argc, const char * argv[]) &#123;
    @autoreleasepool &#123;
        [[[JQObject alloc] init] test];
        [JQObject test];
    &#125;
    return 0;
&#125;</code></pre>









<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css">
    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>ZJQ
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://jqz3.tech/2018/07/18/interview-runtime/" title="【面试题】runtime 相关">https://jqz3.tech/2018/07/18/interview-runtime/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2016/11/22/change-npm-to-yarn/" rel="prev" title="用 yarn 代替 npm 管理 React-Native 包依赖">
                  <i class="fa fa-chevron-left"></i> 用 yarn 代替 npm 管理 React-Native 包依赖
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/06/10/vim/" rel="next" title="vim 操作笔记">
                  vim 操作笔记 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2015 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ZJQ</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">127k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">1:55</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script size="300" alpha="0.6" zIndex="-1" src="https://cdn.jsdelivr.net/npm/ribbon.js@1.0.2/dist/ribbon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.26.0/components/prism-core.min.js" integrity="sha256-NkONGY0/SqGDVmjgrBO5PJutIl5iKA7EsZTfi8pEYP4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.26.0/plugins/autoloader/prism-autoloader.min.js" integrity="sha256-RtKI23ujTCOg3jNK74NK61WGNYbtBWcqh6UKebC2AQo=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.26.0/plugins/line-numbers/prism-line-numbers.min.js" integrity="sha256-K837BwIyiXo5k/9fCYgqUyA14bN4/Ve9P2SIT0KmZD0=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.24.1/plugins/line-highlight/prism-line-highlight.min.js" integrity="sha256-POBDjd0JTDNtT/8+EIh7KG/iUeRbrytoVKBUI9qtvwA=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>

<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@8.13.10/dist/mermaid.min.js","integrity":"sha256-CmZCFVnvol9YL23PfjDflGY5nJwE+Mf/JN+8v+tD/34="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>

  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>

  


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"NDR4ht5tQMwY98BfVRpuVxev-gzGzoHsz","app_key":"t8QAyw6QhVkCuOx3FUpHNehq","server_url":null,"security":false}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"Coder-ZJQ/utterances-comment","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js"></script>

</body>
</html>
